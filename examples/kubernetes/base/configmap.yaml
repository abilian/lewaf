apiVersion: v1
kind: ConfigMap
metadata:
  name: lewaf-config
  namespace: lewaf
  labels:
    app: lewaf
data:
  lewaf.conf: |
    # LeWAF Configuration for Kubernetes
    SecRuleEngine On
    SecRequestBodyAccess On
    SecResponseBodyAccess Off

    # Body Limits
    SecRequestBodyLimit 13107200
    SecRequestBodyNoFilesLimit 131072
    SecRequestBodyLimitAction Reject

    # Temporary Directory
    SecTmpDir /tmp

    # Debug Log
    SecDebugLog /app/logs/debug.log
    SecDebugLogLevel 0

    # Audit Log
    SecAuditEngine RelevantOnly
    SecAuditLog /app/logs/audit.log
    SecAuditLogType Serial
    SecAuditLogFormat JSON
    SecAuditLogParts ABCFHZ

    # Include CRS Setup
    Include /app/config/crs-setup.conf

  crs-setup.conf: |
    # OWASP CRS Configuration

    # Paranoia Level (1-4)
    SecAction \
      "id:900000,\
       phase:1,\
       nolog,\
       pass,\
       t:none,\
       setvar:tx.paranoia_level=1"

    # Anomaly Scoring Threshold
    SecAction \
      "id:900110,\
       phase:1,\
       nolog,\
       pass,\
       t:none,\
       setvar:tx.inbound_anomaly_score_threshold=5,\
       setvar:tx.outbound_anomaly_score_threshold=4"

    # Application Defenses
    SecAction \
      "id:900200,\
       phase:1,\
       nolog,\
       pass,\
       t:none,\
       setvar:tx.allowed_methods=GET HEAD POST OPTIONS,\
       setvar:tx.allowed_request_content_type=|application/x-www-form-urlencoded| |multipart/form-data| |application/json|,\
       setvar:tx.allowed_http_versions=HTTP/1.0 HTTP/1.1 HTTP/2 HTTP/2.0"

    # HTTP Policy Settings
    SecAction \
      "id:900220,\
       phase:1,\
       nolog,\
       pass,\
       t:none,\
       setvar:tx.max_num_args=255,\
       setvar:tx.arg_name_length=100,\
       setvar:tx.arg_length=400,\
       setvar:tx.total_arg_length=64000,\
       setvar:tx.max_file_size=1048576"

    # Sampling Percentage
    SecAction \
      "id:900400,\
       phase:1,\
       nolog,\
       pass,\
       t:none,\
       setvar:tx.sampling_percentage=100"
