# Coraza WAF Configuration for Reverse Proxy
# Based on ModSecurity SecLang syntax

# Basic SQL Injection Detection
SecRule ARGS "@rx (\bunion\b.*\bselect\b|\bselect\b.*\bunion\b)" \
    "id:1001,phase:2,deny,log,msg:'SQL Injection Attack Detected',severity:CRITICAL"

SecRule ARGS "@rx (\bor\b\s+\d+\s*=\s*\d+|\band\b\s+\d+\s*=\s*\d+)" \
    "id:1002,phase:2,deny,log,msg:'SQL Injection - Boolean Based',severity:HIGH"

# XSS Detection
SecRule ARGS "@rx <script[^>]*>" \
    "id:1003,phase:2,deny,log,msg:'XSS Attack - Script Tag',severity:HIGH"

SecRule ARGS "@rx (javascript:|vbscript:|data:|on\w+\s*=)" \
    "id:1004,phase:2,deny,log,msg:'XSS Attack - Event Handler',severity:HIGH"

# Path Traversal
SecRule ARGS "@rx (\.\./|\.\.\%2f)" \
    "id:1005,phase:2,deny,log,msg:'Path Traversal Attack',severity:HIGH"

# Command Injection
SecRule ARGS "@rx (\b(cat|ls|pwd|whoami|id|uname)\b|[;&|`])" \
    "id:1006,phase:2,deny,log,msg:'Command Injection Attempt',severity:CRITICAL"

# File Upload Restrictions
SecRule FILES "@rx \.(exe|bat|cmd|com|scr|pif|vbs|jar)$" \
    "id:1007,phase:2,deny,log,msg:'Dangerous File Upload',severity:HIGH"

# Rate Limiting (Basic)
SecRule IP:REQUEST_COUNT "@gt 100" \
    "id:1008,phase:1,deny,log,msg:'Rate Limit Exceeded - Too Many Requests'"

# User-Agent Filtering
SecRule REQUEST_HEADERS:User-Agent "@rx (sqlmap|nikto|nmap|masscan|zap|burp)" \
    "id:1009,phase:1,deny,log,msg:'Malicious User-Agent Detected',severity:MEDIUM"

# Block Empty User-Agent
SecRule REQUEST_HEADERS:User-Agent "@rx ^$" \
    "id:1010,phase:1,deny,log,msg:'Empty User-Agent Not Allowed',severity:LOW"

# HTTP Method Restrictions
SecRule REQUEST_METHOD "@rx ^(TRACE|TRACK|DEBUG|OPTIONS)$" \
    "id:1011,phase:1,deny,log,msg:'HTTP Method Not Allowed',severity:MEDIUM"

# Large Request Body
SecRule REQUEST_BODY "@gt 1048576" \
    "id:1012,phase:2,deny,log,msg:'Request Body Too Large',severity:MEDIUM"

# Suspicious Headers
SecRule REQUEST_HEADERS:X-Forwarded-For "@rx (\b127\.0\.0\.1\b|\blocalhost\b)" \
    "id:1013,phase:1,deny,log,msg:'Suspicious X-Forwarded-For Header',severity:LOW"