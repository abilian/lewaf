# Logrotate configuration for LeWAF logs
#
# Install: sudo cp logrotate.conf /etc/logrotate.d/lewaf
# Test: logrotate -d /etc/logrotate.d/lewaf
# Force run: logrotate -f /etc/logrotate.d/lewaf

# Application logs
/var/log/lewaf/*.log {
    # Rotate daily
    daily

    # Keep 30 days of logs
    rotate 30

    # Don't error if log file is missing
    missingok

    # Don't rotate empty logs
    notifempty

    # Compress old logs
    compress

    # Delay compression until next rotation
    delaycompress

    # Use date extension (YYYYMMDD)
    dateext
    dateformat -%Y%m%d

    # Create new log file with these permissions
    create 0644 lewaf lewaf

    # Shared scripts for all logs
    sharedscripts

    # Post-rotation script
    postrotate
        # Send SIGHUP to application to reopen log files
        # Uncomment if using systemd:
        # systemctl reload lewaf.service

        # Or send signal directly to process:
        # kill -HUP $(cat /var/run/lewaf.pid) 2>/dev/null || true

        # Or restart containers:
        # docker-compose -f /path/to/docker-compose.yml restart lewaf-app
    endscript
}

# Audit logs (security-critical, keep longer)
/var/log/lewaf/audit-*.log {
    # Rotate weekly
    weekly

    # Keep 52 weeks (1 year)
    rotate 52

    # Don't error if log file is missing
    missingok

    # Don't rotate empty logs
    notifempty

    # Compress old logs
    compress

    # Delay compression
    delaycompress

    # Use date extension
    dateext
    dateformat -%Y%m%d

    # Create new log file
    create 0600 lewaf lewaf

    # Shared scripts
    sharedscripts

    postrotate
        # Audit logs are append-only, usually don't need reload
        # But you can trigger backup or archival here
        # /usr/local/bin/backup-audit-logs.sh
    endscript
}

# Nginx access logs (if using nginx reverse proxy)
/var/log/nginx/access.log {
    daily
    rotate 14
    missingok
    notifempty
    compress
    delaycompress
    dateext
    create 0644 nginx nginx

    sharedscripts
    postrotate
        # Reload nginx to reopen log files
        nginx -s reopen
    endscript
}

# Nginx error logs
/var/log/nginx/error.log {
    daily
    rotate 14
    missingok
    notifempty
    compress
    delaycompress
    dateext
    create 0644 nginx nginx

    sharedscripts
    postrotate
        nginx -s reopen
    endscript
}
