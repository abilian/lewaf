# Rsyslog configuration for LeWAF centralized logging
#
# This configuration forwards LeWAF logs to a centralized log server
#
# Install: sudo cp rsyslog.conf /etc/rsyslog.d/50-lewaf.conf
# Restart: sudo systemctl restart rsyslog

# Load modules
module(load="imfile" PollingInterval="10")

# LeWAF Application Logs
input(type="imfile"
      File="/var/log/lewaf/app.log"
      Tag="lewaf-app"
      Severity="info"
      Facility="local0"
      reopenOnTruncate="on"
      addMetadata="on")

# LeWAF Audit Logs (security events)
input(type="imfile"
      File="/var/log/lewaf/audit-prod.log"
      Tag="lewaf-audit"
      Severity="warning"
      Facility="local1"
      reopenOnTruncate="on"
      addMetadata="on")

# Format logs as JSON for easier parsing
template(name="lewaf-json" type="list") {
    constant(value="{")
    constant(value="\"timestamp\":\"")      property(name="timereported" dateFormat="rfc3339")
    constant(value="\",\"host\":\"")        property(name="hostname")
    constant(value="\",\"severity\":\"")    property(name="syslogseverity-text")
    constant(value="\",\"facility\":\"")    property(name="syslogfacility-text")
    constant(value="\",\"tag\":\"")         property(name="syslogtag" format="json")
    constant(value="\",\"message\":\"")     property(name="msg" format="json")
    constant(value="\"}")
    constant(value="\n")
}

# Forward to centralized log server
# Option 1: TCP (reliable)
# action(type="omfwd"
#        Target="logserver.example.com"
#        Port="514"
#        Protocol="tcp"
#        template="lewaf-json"
#        queue.type="LinkedList"
#        queue.filename="lewaf-fwd"
#        action.resumeRetryCount="-1"
#        queue.saveOnShutdown="on")

# Option 2: TLS (secure)
# global(DefaultNetstreamDriver="gtls"
#        DefaultNetstreamDriverCAFile="/etc/ssl/certs/ca.pem"
#        DefaultNetstreamDriverCertFile="/etc/ssl/certs/cert.pem"
#        DefaultNetstreamDriverKeyFile="/etc/ssl/private/key.pem")
#
# action(type="omfwd"
#        Target="logserver.example.com"
#        Port="6514"
#        Protocol="tcp"
#        StreamDriver="gtls"
#        StreamDriverMode="1"
#        StreamDriverAuthMode="x509/name"
#        StreamDriverPermittedPeers="logserver.example.com"
#        template="lewaf-json")

# Option 3: Syslog to Elasticsearch (via omhttp)
# action(type="omhttp"
#        server="elasticsearch.example.com"
#        serverport="9200"
#        restpath="lewaf-logs/_doc"
#        template="lewaf-json"
#        httpcontenttype="application/json")

# Local file backup (in addition to forwarding)
if $syslogtag == 'lewaf-app' then {
    action(type="omfile" file="/var/log/lewaf/app.log")
}

if $syslogtag == 'lewaf-audit' then {
    action(type="omfile" file="/var/log/lewaf/audit-prod.log")
}

# Stop processing after handling LeWAF logs
& stop
